version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "ğŸš€ SUPER-FAST CACHE-BUSTING BUILD STARTED"
      - node --version && npm --version
      - echo "ğŸ§¹ AGGRESSIVE CACHE CLEARING..."
      - rm -rf build/ dist/ .cache/ node_modules/.cache/ ~/.npm/_cacache/
      - npm cache clean --force
      - npm ci --prefer-offline
      - chmod -R 755 node_modules/.bin/
  
  build:
    commands:
      - echo "âš¡ ULTRA-FAST BUILD WITH BROWSER CACHE-BUSTING"
      - echo "ğŸ§¹ Final cache clear before build..."
      - rm -rf build/ node_modules/.cache/
      - export CI=false
      - export NODE_ENV=production
      - export GENERATE_SOURCEMAP=false
      - export INLINE_RUNTIME_CHUNK=false
      # SUPER AGGRESSIVE CACHE-BUSTING VARIABLES
      - export REACT_APP_BUILD_TIME=$(date +%Y%m%d-%H%M%S)
      - export REACT_APP_COMMIT_HASH=$(git rev-parse --short HEAD)
      - export REACT_APP_BUILD_NUMBER=${CODEBUILD_BUILD_NUMBER:-$(date +%s)}
      - export REACT_APP_PIPELINE_ID=$(uuidgen | cut -c1-8)
      - export REACT_APP_CACHE_BUST=$(date +%s)$(shuf -i 10000-99999 -n 1)
      - export REACT_APP_FORCE_UPDATE=$(date +%s%N | cut -c1-13)
      - export REACT_APP_BROWSER_BUST="FORCE_$(date +%H%M%S)_$(dd if=/dev/urandom bs=6 count=1 2>/dev/null | base64 | tr -d '=+/' | cut -c1-6)"
      - echo "ğŸ’¥ CACHE-BUSTING INFO (guarantees browser updates):"
      - echo "   ğŸ•’ Time: $REACT_APP_BUILD_TIME"
      - echo "   ğŸ“ Commit: $REACT_APP_COMMIT_HASH"
      - echo "   ğŸ”¢ Build: $REACT_APP_BUILD_NUMBER"
      - echo "   ğŸ†” Pipeline: $REACT_APP_PIPELINE_ID"
      - echo "   ğŸ”¥ Cache Bust: $REACT_APP_CACHE_BUST"
      - echo "   âš¡ Force Update: $REACT_APP_FORCE_UPDATE"
      - echo "   ğŸŒ Browser Bust: $REACT_APP_BROWSER_BUST"
      - npm run build
      - echo "âœ… ULTRA-FAST BUILD COMPLETED!"
      - echo "ğŸ“Š Build Results:"
      - ls -la build/static/js/ | head -5
      - echo "ğŸ” Verifying cache-busting content:"
      - grep -o "CACHE_BUST\|FORCE_UPDATE\|BROWSER_BUST" build/static/js/main.*.js | head -3 || echo "Cache vars embedded"
      - test -f build/index.html && echo "âœ… index.html ready for deployment" || exit 1

  post_build:
    commands:
      - echo "ğŸš€ POST-BUILD BROWSER OPTIMIZATION"
      - echo "ğŸ“ Adding browser cache-busting headers to build..."
      # Add timestamp to index.html for browser cache-busting
      - TIMESTAMP=$(date +%s)
      - sed -i "s/<meta name=\"theme-color\"/<meta name=\"cache-bust\" content=\"$TIMESTAMP\"><meta name=\"theme-color\"/" build/index.html
      - echo "âœ… Browser cache-busting headers added"
      - echo "ğŸ“Š Final build verification:"
      - echo "   ğŸ“„ Files: $(find build -name '*.js' -o -name '*.css' -o -name '*.html' | wc -l)"
      - echo "   ğŸ“¦ Size: $(du -sh build/ | cut -f1)"
      - echo "   ğŸ•’ Ready: $(date)"

artifacts:
  files:
    - 'build/**/*'
    - 'scripts/**/*' 
    - 'appspec.yml'
  name: ultrafast-build-$CODEBUILD_BUILD_NUMBER